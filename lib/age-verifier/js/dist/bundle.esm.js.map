{"version":3,"file":"bundle.esm.js","sources":["../src/index.js"],"sourcesContent":["export default class AgeVerifier {\n    constructor(config) {\n        if (!config || !config.backendEndpoints) {\n            throw new Error(\n                \"AgeVerifier configuration is invalid. Please provide backendEndpoints.\"\n            );\n        }\n        this.endpoints = config.backendEndpoints;\n        this.callbacks = {\n            onVerificationNeeded: config.onVerificationNeeded || (() => {}),\n            onVerificationNotNeeded:\n                config.onVerificationNotNeeded || (() => {}),\n            onSuccess: config.onSuccess || (() => {}),\n            onFail: config.onFail || (() => {}),\n            onError: config.onError || (() => {}),\n        };\n        this.verificationApiDomain = config.verificationApiDomain;\n        this.iframe = null;\n        this._handlePostMessage = this._handlePostMessage.bind(this);\n    }\n\n    async checkVerificationNeeded() {\n        try {\n            const response = await fetch(this.endpoints.checkNeeded);\n            if (!response.ok) {\n                throw new Error(`HTTP error! status: ${response.status}`);\n            }\n            const data = await response.json();\n\n            // В соответствии с PRD, маршрутизируем ответ по колбэкам\n            if (data.result) {\n                switch (data.result.status) {\n                    case 0: // Не требуется\n                        this.callbacks.onVerificationNotNeeded(data);\n                        break;\n                    case 2: // Уже пройдена\n                        this.callbacks.onSuccess(data);\n                        break;\n                    case 1: // Требуется\n                        this.callbacks.onVerificationNeeded(data);\n                        break;\n                    case 3: // Провалена\n                        this.callbacks.onFail(data);\n                        break;\n                    default:\n                        this.callbacks.onError(\n                            new Error(`Unknown status: ${data.result.status}`)\n                        );\n                }\n            } else {\n                this.callbacks.onError(\n                    new Error(\"Invalid response structure from server\")\n                );\n            }\n        } catch (error) {\n            this.callbacks.onError(error);\n        }\n    }\n\n    async startVerification(hostElement) {\n        if (!hostElement || typeof hostElement.appendChild !== \"function\") {\n            const error = new Error(\n                \"A valid hostElement must be provided to startVerification.\"\n            );\n            this.callbacks.onError(error);\n            return;\n        }\n\n        try {\n            const response = await fetch(this.endpoints.startVerification);\n            if (!response.ok) {\n                throw new Error(`HTTP error! status: ${response.status}`);\n            }\n            const data = await response.json();\n\n            if (data.href) {\n                const iframe = document.createElement(\"iframe\");\n                iframe.src = data.href;\n                iframe.style.width = \"100%\";\n                iframe.style.height = \"100%\";\n                iframe.style.border = \"none\";\n\n                // Очищаем хост-элемент и добавляем iframe\n                hostElement.innerHTML = \"\";\n                hostElement.appendChild(iframe);\n                this.iframe = iframe;\n\n                window.addEventListener(\"message\", this._handlePostMessage);\n            } else {\n                // Если URL не пришел, считаем это успехом без верификации (согласно PRD)\n                this.callbacks.onSuccess(data);\n            }\n        } catch (error) {\n            this.callbacks.onError(error);\n        }\n    }\n\n    _handlePostMessage(event) {\n        if (event.origin !== this.verificationApiDomain) {\n            return;\n        }\n\n        if (event.data && event.data.result === \"finished\") {\n            this.fetchResult();\n        }\n    }\n\n    async fetchResult() {\n        try {\n            const response = await fetch(this.endpoints.checkResult);\n            if (!response.ok) {\n                throw new Error(`HTTP error! status: ${response.status}`);\n            }\n            const data = await response.json();\n\n            if (\n                data.result &&\n                (data.result.status === 1 || data.result.status === 2)\n            ) {\n                this.callbacks.onSuccess(data);\n            } else {\n                this.callbacks.onFail(data);\n            }\n        } catch (error) {\n            this.callbacks.onError(error);\n        } finally {\n            this._cleanup();\n        }\n    }\n\n    async updateVerificationResult() {\n        const response = await fetch(this.endpoints.updateVerificationResult, {\n            method: \"POST\",\n        });\n    }\n\n    _cleanup() {\n        if (this.iframe && this.iframe.parentNode) {\n            this.iframe.parentNode.removeChild(this.iframe);\n        }\n        this.iframe = null;\n        window.removeEventListener(\"message\", this._handlePostMessage);\n    }\n}\n"],"names":[],"mappings":"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"}