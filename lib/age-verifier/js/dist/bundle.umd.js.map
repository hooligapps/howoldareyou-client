{"version":3,"file":"bundle.umd.js","sources":["../src/index.js"],"sourcesContent":["export default class AgeVerifier {\n    constructor(config) {\n        if (!config || !config.backendEndpoints) {\n            throw new Error(\n                \"AgeVerifier configuration is invalid. Please provide backendEndpoints.\"\n            );\n        }\n        this.endpoints = config.backendEndpoints;\n        this.callbacks = {\n            onVerificationNeeded: config.onVerificationNeeded || (() => {}),\n            onVerificationNotNeeded:\n                config.onVerificationNotNeeded || (() => {}),\n            onSuccess: config.onSuccess || (() => {}),\n            onFail: config.onFail || (() => {}),\n            onError: config.onError || (() => {}),\n        };\n        this.verificationApiDomain = config.verificationApiDomain;\n        this.iframe = null;\n        this._handlePostMessage = this._handlePostMessage.bind(this);\n    }\n\n    async checkVerificationNeeded() {\n        try {\n            const response = await fetch(this.endpoints.checkNeeded);\n            if (!response.ok) {\n                throw new Error(`HTTP error! status: ${response.status}`);\n            }\n            const data = await response.json();\n\n            // В соответствии с PRD, маршрутизируем ответ по колбэкам\n            if (data.result) {\n                switch (data.result.status) {\n                    case 0: // Не требуется\n                        this.callbacks.onVerificationNotNeeded(data);\n                        break;\n                    case 2: // Уже пройдена\n                        this.callbacks.onSuccess(data);\n                        break;\n                    case 1: // Требуется\n                        this.callbacks.onVerificationNeeded(data);\n                        break;\n                    case 3: // Провалена\n                        this.callbacks.onFail(data);\n                        break;\n                    default:\n                        this.callbacks.onError(\n                            new Error(`Unknown status: ${data.result.status}`)\n                        );\n                }\n            } else {\n                this.callbacks.onError(\n                    new Error(\"Invalid response structure from server\")\n                );\n            }\n        } catch (error) {\n            this.callbacks.onError(error);\n        }\n    }\n\n    async startVerification(hostElement) {\n        if (!hostElement || typeof hostElement.appendChild !== \"function\") {\n            const error = new Error(\n                \"A valid hostElement must be provided to startVerification.\"\n            );\n            this.callbacks.onError(error);\n            return;\n        }\n\n        try {\n            const response = await fetch(this.endpoints.startVerification);\n            if (!response.ok) {\n                throw new Error(`HTTP error! status: ${response.status}`);\n            }\n            const data = await response.json();\n\n            if (data.url) {\n                const iframe = document.createElement(\"iframe\");\n                iframe.src = data.url;\n                iframe.style.width = \"100%\";\n                iframe.style.height = \"100%\";\n                iframe.style.border = \"none\";\n\n                // Очищаем хост-элемент и добавляем iframe\n                hostElement.innerHTML = \"\";\n                hostElement.appendChild(iframe);\n                this.iframe = iframe;\n\n                window.addEventListener(\"message\", this._handlePostMessage);\n            } else {\n                // Если URL не пришел, считаем это успехом без верификации (согласно PRD)\n                this.callbacks.onSuccess(data);\n            }\n        } catch (error) {\n            this.callbacks.onError(error);\n        }\n    }\n\n    _handlePostMessage(event) {\n        if (event.origin !== this.verificationApiDomain) {\n            return;\n        }\n\n        if (event.data && event.data.result === \"finished\") {\n            this.fetchResult();\n        }\n    }\n\n    async fetchResult() {\n        try {\n            const response = await fetch(this.endpoints.checkResult);\n            if (!response.ok) {\n                throw new Error(`HTTP error! status: ${response.status}`);\n            }\n            const data = await response.json();\n\n            if (\n                data.result &&\n                (data.result.status === 1 || data.result.status === 2)\n            ) {\n                this.callbacks.onSuccess(data);\n            } else {\n                this.callbacks.onFail(data);\n            }\n        } catch (error) {\n            this.callbacks.onError(error);\n        } finally {\n            this._cleanup();\n        }\n    }\n\n    async updateVerificationResult() {\n        const response = await fetch(this.endpoints.updateVerificationResult, {\n            method: \"POST\",\n        });\n    }\n\n    _cleanup() {\n        if (this.iframe && this.iframe.parentNode) {\n            this.iframe.parentNode.removeChild(this.iframe);\n        }\n        this.iframe = null;\n        window.removeEventListener(\"message\", this._handlePostMessage);\n    }\n}\n"],"names":[],"mappings":"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"}