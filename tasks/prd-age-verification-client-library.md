# PRD: Клиентская библиотека для проверки возраста

## 1. Введение и общая картина

Этот документ описывает требования к клиентской библиотеке, предназначенной для интеграции сервиса проверки возраста в стороннее приложение (далее "Игра"). Библиотека упрощает взаимодействие с API сервера верификации, инкапсулируя логику запросов и встраивания интерфейса проверки.

Библиотека будет состоять из двух основных частей:

1.  **Клиентская часть (JavaScript):** Модуль для браузера, который управляет отображением `iframe` с процессом верификации и обрабатывает результат.
2.  **Серверная часть (Python):** Модуль для бэкенда Игры, который обеспечивает безопасное S2S (server-to-server) взаимодействие с API сервера верификации.

## 2. Цели

-   Предоставить разработчикам простой и переиспользуемый инструмент для встраивания проверки возраста.
-   Абстрагировать логику взаимодействия с API верификации, включая формирование запросов и вычисление криптографических подписей.
-   Обеспечить гибкие варианты поставки клиентской части: как ES-модуль для современных сборщиков (Webpack, Vite), так и в виде standalone-скрипта.
-   Предоставить четкий и безопасный интерфейс на Python для взаимодействия с бэкендом.

## 3. Пользовательские истории

-   **Как разработчик,** я хочу интегрировать проверку возраста, вызвав одну JS-функцию и передав ей колбэки на успех/неудачу, чтобы не реализовывать логику `iframe` и `postMessage` самостоятельно.
-   **Как разработчик,** я хочу использовать готовый Python-модуль, который сам формирует и подписывает запросы к API верификации, чтобы обеспечить безопасность и не вникать в детали реализации HMAC-SHA256.
-   **Как новый пользователь,** я хочу нажать на кнопку "Мне есть 18 лет", пройти простую процедуру проверки и без проблем продолжить пользоваться Игрой.

## 4. Функциональные требования

### 4.1. Клиентская библиотека (JavaScript)

Библиотека должна представлять собой класс или фабрику функций для создания экземпляра верификатора. Логика работы предполагает двухэтапный процесс: сначала фоновая проверка необходимости верификации, а затем — запуск самой процедуры по требованию.

#### **Инициализация**

Библиотека должна инициализироваться с помощью конфигурационного объекта. Обратите внимание, что `hostElement` здесь не передается.

```javascript
const ageVerifier = new AgeVerifier({
    // Домен API верификации для проверки источника postMessage
    verificationApiDomain: "https://verification.service.com",

    // Эндпоинты на бэкенде Игры
    backendEndpoints: {
        checkNeeded: "/api/age-verification/check-needed",
        startVerification: "/api/age-verification/start",
        checkResult: "/api/age-verification/check-result",
    },

    // Колбэк, вызываемый после фоновой проверки.
    // Позволяет приложению решить, нужно ли показывать UI верификации.
    onVerificationNeeded: (response) => {
        // Этот колбэк вызывается, только если response.result.status === 1
        // т.е. когда требуется активное прохождение верификации.
        console.log("Verification is required, showing UI.");
        showVerificationButton();
    },
    onVerificationNotNeeded: (response) => {
        // Этот колбэк вызывается, только если response.result.status === 0
        // т.е. когда проверка не требуется.
        console.log("Verification is not required.");
    },

    // Колбэки для обработки финального результата.
    // Принимают полный, немодифицированный ответ от сервера.
    onSuccess: (response) => console.log("Проверка пройдена!", response),
    onFail: (response) => console.log("Проверка провалена.", response),
    onError: (error) => console.error("Произошла ошибка.", error),
});
```

#### **Фоновая проверка: `checkVerificationNeeded()`**

-   Метод `ageVerifier.checkVerificationNeeded()` должен вызываться при загрузке страницы для определения, нужна ли верификация.
-   Он отправляет AJAX-запрос на эндпоинт `backendEndpoints.checkNeeded`.
-   **Логика обработки ответа:**
    -   Если сервер возвращает статус, означающий, что проверка **не требуется** или **уже успешно пройдена** (например, `status: 0` или `status: 2`), библиотека должна вызвать колбэк `onSuccess`, передав в него полный ответ сервера.
    -   Если сервер возвращает статус, означающий, что проверка **уже была провалена** (например, `status: 3`), библиотека должна вызвать колбэк `onFail`, передав в него полный ответ сервера.
    -   Если сервер возвращает статус, означающий, что **требуется активная проверка** (например, `status: 1`), библиотека должна вызвать колбэк `onVerificationNeeded`. Это сигнал для приложения, что нужно отобразить пользователю UI для запуска верификации (кнопку и т.д.).
    -   Если сервер возвращает статус, означающий, что проверка **не требуется** (например, `status: 0`), библиотека должна вызвать колбэк `onVerificationNotNeeded`. Это сигнал для приложения, что проверка не требуется.
    -   В случае сетевой или серверной ошибки вызывается `onError`.

#### **Основной метод: `startVerification(hostElement)`**

-   Метод `ageVerifier.startVerification(hostElement)` запускает основной процесс проверки.
-   **`hostElement` (обязательный):** DOM-элемент, в который будет встроен `iframe`. Передается непосредственно при запуске, а не при инициализации.
-   При вызове он отправляет AJAX-запрос на эндпоинт `backendEndpoints.startVerification` на сервере Игры.
-   Сервер Игры (используя Python-модуль) обращается к API верификации и возвращает URL для `iframe`.
-   Библиотека создает `<iframe>` с полученным URL и встраивает его в переданный `hostElement`.
-   Библиотека устанавливает обработчик событий `window.addEventListener('message', ...)` для получения результата из `iframe`.

#### **Обработка событий**

-   Обработчик `message` должен строго проверять `event.origin` на соответствие `verificationApiDomain`.
-   Когда из `iframe` приходит сообщение о завершении (`{result: "finished"}`), библиотека должна:
    1.  Отправить запрос на эндпоинт `backendEndpoints.checkResult` для получения финального статуса.
    2.  В зависимости от ответа, вызвать соответствующий колбэк: `onSuccess`, `onFail` или `onError`, передав в него полный ответ сервера.
    3.  Удалить `iframe` из `hostElement` и снять обработчик событий `message` для очистки.

#### **Варианты сборки**

-   Должна быть предусмотрена сборка в формате **ES-модуля** для использования с `import`.
-   Должна быть предусмотрена сборка в формате **UMD (standalone)**, чтобы библиотеку можно было подключить на страницу через тег `<script>`.

---

### 4.2. Серверный модуль (Python)

Модуль должен представлять собой набор чистых функций, не хранящих состояние. Вся необходимая информация (включая `apiKey` и `apiId`) передается в качестве аргументов.

#### **Структура**

-   Модуль поставляется в виде Python-пакета (папка с файлами `.py` и `__init__.py`), который можно поместить в проект Игры.

#### **Функции**

1.  **`start_check_age_verification(api_id: str, api_key: str, session_id: str, client_ip: str, redirect_url: str, user_id: str = None) -> dict`**

    -   Реализует логику запроса `api/check-age-verification`.
    -   Принимает все необходимые параметры.
    -   Формирует `nonce` и другие данные.
    -   Вычисляет подпись HMAC-SHA256.
    -   Отправляет запрос к API верификации.
    -   Возвращает ответ от API в виде словаря (e.g. `{"href": "..."}` или `{"result": "success"}`).

2.  **`check_age_verification_result(api_id: str, api_key: str, session_id: str) -> dict`**

    -   Реализует логику запроса `api/check-age-verification-result`.
    -   Принимает `api_id`, `api_key`, `session_id`.
    -   Формирует и подписывает запрос.
    -   Возвращает финальный статус проверки из API верификации (`{"result": status}`).

3.  **`update_verification_result(api_id: str, api_key: str, session_id: str, user_id: str) -> dict`**

    -   Реализует логику запроса `api/update-verification-result`.
    -   Используется после успешной регистрации нового пользователя для привязки `userId` к сессии верификации.
    -   Формирует и подписывает запрос.
    -   Возвращает ответ от API.

4.  **`need_verification(api_key: str, client_ip: str, user_id: str) -> dict`**
    -   Реализует логику запроса `api/need-verification` для проверки существующих пользователей.
    -   Формирует и подписывает запрос.
    -   Возвращает ответ от API (`{"result": status}`).

#### **Безопасность и зависимости**

-   Все функции должны корректно реализовывать механизм подписи запросов HMAC-SHA256, как описано в исходном PRD.
-   Модуль будет иметь зависимости от библиотек `requests` (для HTTP-запросов) и `hashlib`, `hmac` (стандартные). Необходимо предоставить файл `requirements.txt`.

## 5. Вне рамок (Non-Goals)

-   Библиотека **не рендерит** никаких элементов UI, кроме `iframe`. Кнопки, модальные окна, оверлеи и тексты создаются на стороне Игры.
-   Python-модуль **не управляет состоянием** и не хранит результаты проверок в базе данных. Эта логика остается на стороне Игры.
-   Библиотека **не включает** в себя веб-сервер. Python-модуль предназначен для использования внутри существующего веб-фреймворка (Flask, Django, FastAPI и т.д.).

## 6. Технические и дизайн-соображения

-   **JS:** Клиентская библиотека должна быть легковесной и, по возможности, не иметь внешних зависимостей.
-   **Python:** В модуле следует предусмотреть понятное логирование ошибок для упрощения отладки интеграции.
-   **iframe:** `iframe` должен стилистически занимать все доступное пространство в переданном ему `hostElement`.

## 7. Решенные вопросы и принятые решения

-   **Логика повторных запросов (Retries):** Реализация логики повторных запросов при сетевых ошибках или таймаутах является ответственностью основного приложения (Игры), а не библиотеки.
-   **Структура данных в колбэках:** Колбэки `onSuccess`, `onFail`, `onVerificationNeeded` и `onError` должны получать полную, необработанную структуру ответа (JSON), которую возвращает сервер Игры. Это дает максимальную гибкость приложению-интегратору.
