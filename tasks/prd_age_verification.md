# Сценарии проверки возраста

## Cценарий проверки возраста с т.з Игры

0. Настройки сервера Игры

-   на сервере Игры есть параметры appId и apiKey от verivication API (API-сервер)
-   сервер Игры может сохранять соостояние проверки возраста в данных пользователя

1. Сервер Игры инициализирует сессию с новым id (игровой sessionId)
2. Сервер Игры проверяет, зарегистрирован ли юзер, который пытается войти в игру
    - если юзер зарегистрирован:
        - если юзер уже прошел проверку, то пропускаем процедуру проверки (выход из сценария)
        - если проверка не пройдена, то игровой сервер шлет запрос на API-сервер api/need-verification с параметрами:
            - clientIp
            - userId
            - signature
        - API-сервер проверяет параметры и возвращает ответ {result: status} (про статус ниже)
        - если status 0, то пропускаем процедуру проверки (выход из сценария)
        - если status 1, 4, 5 то приступаем к следующему пункту сценария
        - если status 2, то пропускаем процедуру проверки (выход из сценария)
        - если status 3, то интерфейс Игры показывает сообщение о том, что проверка не пройдена и блокирует игру (выход из сценария)
    - если юзер не зарегистрирован, то приступаем к следующему пункту сценария
3. Сервер Игры шлет запрос на API-сервер api/check-age-verification с параметрами:
    - sessionId
    - clientIp
    - appId
    - userId (id игрока в игровом сервере, если есть)
    - signature
4. API-сервер проверяет параметры и возвращает:
    - ответ {result: 0} если проверка не требуется (выход из сценария)
    - ответ {result: 1, url: "ссылка на страницу с проверкой"} если проверка требуется
5. В случае если требуется проверка
    - Игра открывает новое окно (таб) по адресу, переданному в ответе API-сервера.
    - Окно Игры подписывается на сообщения от окна проверки.
    - По окончанию проверки окно проверки переводится на страницу возврата, указанную при инициализации сессии.
    - на этой странице скрипт посылает сообщение родительскому окну о завершении проверки
    - родительское окно получает сообщение, окно проверки закрывается и переходим к пункту 6 сценария
6. Подтверждение проверки возраста
    - сервер Игры шлет запрос на API-сервер api/check-age-verification-result с параметрами:
        - sessionId
        - appId
        - signature
    - API-сервер проверяет параметры и возвращает ответ {result: status} (про статус ниже)
    - если result 4, то сервер Игры пересылает запрос на API-сервер api/check-age-verification-result через 1 секунду, пока не получит результат
    - если result 5, то выводится сообщение об ошибке с возможностью перезагрузки страницы (выход из сценария)
    - если result 3, то выводится сообщение о неудовлетворительном возрасте (выход из сценария)
    - если result 2, то Игра продолжается (выход из сценария)
    - если пользователь уже существует на сервере Игры
        - сервер Игры сохраняет состояние проверки возраста в данных пользователя
        - если result 2, то Игра продолжается (выход из сценария)
        - если result 3, то Игра блокируется (выход из сценария)
    - если пользователь не существует на сервере Игры
        - сервер Игры записывает в сессию результат проверки возраста
        - если result 2
            - сервер Игры регистрирует пользователя
            - после регистрации пользователя, сервер Игры шлет запрос на API-сервер api/update-verification-result с параметрами:
                - sessionId
                - appId
                - userId
                - signature
        - если result 3, то пользователь не регистрируется (выход из сценария)

## Cценарий проверки возраста с т.з API-сервера

0. Настройки API-сервера

    - API-сервере есть параметры appId и apiKey для каждого клиента, который использует API-сервер
    - API-сервер хранит белый список iserId для каждого appId
    - API-сервер хранит хранит соответствие GEOIP-регионов и статуса требования проверки
    - API-сервер хранит лог проверок возраста для каждого клиента в формате:
        - appId (id клиента - сервера игры)
        - clientIp (ip игрока)
        - userId (id игрока в игровом сервере)
        - sessionId (сессия игры)
        - serviceSessionId (сессия сервиса проверки возраста)
        - result: status
        - timestamp
        - geoIpRegion

1. функция проверки возраста, checkAgeVerificationLocal, используя локальные данные
    - возвращает status:int (про статус ниже)
    - параметры:
        - clientIp
        - userId
    - проверки:
        1. проверяет, есть ли clientIp в регионах, для которых требуется проверка возраста. Если нет, то возвращает 0
        2. проверяет, есть ли userId в логе проверок возраста для данного appId. Если есть, то возвращает 2 (пройдена успешно) или 3 (провал)
        3. проверяет, есть ли userId в белом списке для данного appId. Если нет, то возвращает 0
        4. возвращает 1 (требуется проверка)
2. страница вебхука, которая принимает сообщения от сервиса проверки возраста
    - принимает результат проверки возраста и сохраняет статус проверки:
        - 2 - пройдена успешно
        - 3 - провал
        - 5 - ошибка
    - сохраняет результат проверки в лог по переданному serviceSessionId
3. страница для возврата с сервиса проверки возраста
    - шлет сообщение родительскому окну о завершении проверки
4. api/need-verification
    - параметры:
        - clientIp
        - userId
        - signature
    - возвращает {result: checkAgeVerificationLocal(clientIp, userId)}
5. api/check-age-verification
    - параметры:
        - sessionId
        - clientIp
        - appId
        - userId
        - signature
    - вызывает функцию checkAgeVerificationLocal(clientIp, userId)
    - если status 1:
        1. Сохраняет запись в лог проверок возраста для данного appId
            - appId
            - clientIp
            - userId
            - sessionId
            - geoIpRegion
        2. получает новую сессию serviceSessionId
            - добавляет serviceSessionId в запись лога
        3. формирует ссылку для перенаправления на страницу проверки возраста
        4. возвращает {result: 1, url: "ссылка на страницу с проверкой"}
    - если статус 0, то возвращает {result: 0}
6. api/check-age-verification-result
    - параметры:
        - sessionId
        - appId
        - signature
    - проверяет, есть ли sessionId в логе проверок возраста для данного appId.
        - если есть, то возвращает {result: status} (про статус ниже)
        - если нет, то возвращает {result: 5}
7. api/update-verification-result
    - параметры:
        - sessionId
        - appId
        - userId
        - signature
    - сохраняет userId в запись лога проверок возраста для данного appId и sessionId

## Статусы проверки

-   0 - проверка не требуется
-   1 - проверка требуется
-   2 - клиент уже проходил проверку, прошел успешно
-   3 - клиент уже проходил проверку, провал
-   4 - проверка в процессе
-   5 - ошибка

## Процедура подписи

Отсортированные параметры, без signature, конкатенируются в строку, приводится к нижнему регистру и к ним добавляется api_key. После этого строка хешируется SHA1.

Пример на Python:

```python
import hashlib

def get_signature(data: dict[str, Any], api_key: str):
    keys = sorted([k for k in data.keys() if k != "signature"])
    sign_str = "".join([str(data[k]) for k in keys]).lower() + api_key
    return hashlib.sha1(sign_str.encode()).hexdigest()
```
