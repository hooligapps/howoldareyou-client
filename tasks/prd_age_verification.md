# Сценарии проверки возраста

## Cценарий проверки возраста с т.з Игры

0. Настройки сервера Игры

-   на сервере Игры есть параметры apiId и apiKey от verivication API (API-сервер)
-   сервер Игры может сохранять соостояние проверки возраста в данных пользователя

1. Сервер Игры инициализирует сессию с новым id (игровой sessionId)
2. Сервер Игры проверяет, зарегистрирован ли юзер, который пытается войти в игру
    - если юзер зарегистрирован:
        - если юзер уже прошел проверку, то пропускаем процедуру проверки (выход из сценария)
        - если проверка не пройдена, то игровой сервер шлет запрос на API-сервер api/need-verification с параметрами:
            - clientIp
            - userId
            - signature (HMAC-SHA256(apiKey + параметры))
        - API-сервер проверяет параметры и возвращает ответ {result: status}, где status
            - 0 - проверка не требуется
            - 1 - проверка требуется
            - 2 - клиент уже проходил проверку, прошел успешно
            - 3 - клиент уже проходил проверку, провал
        - если status 0, то пропускаем процедуру проверки (выход из сценария)
        - если status 1, то приступаем к следующему пункту сценария
        - если status 2, то пропускаем процедуру проверки (выход из сценария)
        - если status 3, то интерфейс Игры показывает сообщение о том, что проверка не пройдена и блокирует игру (выход из сценария)
    - если юзер не зарегистрирован, то приступаем к следующему пункту сценария
3. Сервер Игры шлет запрос на API-сервер api/check-age-verification с параметрами:
    - sessionId
    - clientIp
    - apiId
    - userId (id игрока в игровом сервере, если есть)
    - signature (HMAC-SHA256(apiKey + параметры))
4. API-сервер проверяет параметры и возвращает:
    - ответ {result: "success"} если проверка не требуется (выход из сценария)
    - ответ {href: "ссылка на страницу с проверкой"} если проверка требуется
5. В случае если требуется проверка
    - Игра открывает в iframe окно по адресу, переданному в ответе API-сервера.
    - Окно Игры подписывается на сообщения от окна проверки.
    - По окончанию проверки окно проверки переводится на страницу возврата, указанную при инициализации сессии.
    - на этой странице скрипт посылает сообщение родительскому окну о завершении проверки
    - родительское окно получает сообщение, закрывает окно проверки и переходит к пункту 5 сценария
6. Подтверждение проверки возраста
    - сервер Игры шлет запрос на API-сервер api/check-age-verification-result с параметрами:
        - sessionId
        - apiId
        - signature (HMAC-SHA256(apiKey + параметры))
    - API-сервер проверяет параметры и возвращает ответ {result: status}, где status
        - 0 - not-found
        - 1 - success
        - 2 - fail
        - 3 - error
        - 4 - pending
    - если result "pending", то сервер Игры пересылает запрос на API-сервер api/check-age-verification-result через 1 секунду, пока не получит результат
    - если result "not-found", то выводится сообщение об ошибке с возможностью перезагрузки страницы (выход из сценария)
    - если result "error", то выводится сообщение об ошибке с возможностью перезагрузки страницы (выход из сценария)
    - если result "success", то Игра продолжается (выход из сценария)
    - если пользователь уже существует на сервере Игры
        - сервер Игры сохраняет состояние проверки возраста в данных пользователя
        - если result "success", то Игра продолжается (выход из сценария)
        - если result "fail", то Игра блокируется (выход из сценария)
    - если пользователь не существует на сервере Игры
        - сервер Игры записывает в сессию результат проверки возраста
        - если result "success"
            - сервер Игры регистрирует пользователя
            - после регистрации пользователя, сервер Игры шлет запрос на API-сервер api/update-verification-result с параметрами:
                - sessionId
                - apiId
                - userId
                - signature (HMAC-SHA256(apiKey + параметры))
        - если result "fail", то пользователь не регистрируется (выход из сценария)

## Cценарий проверки возраста с т.з API-сервера

0. Настройки API-сервера

    - API-сервере есть параметры apiId и apiKey для каждого клиента, который использует API-сервер
    - API-сервер хранит белый список iserId для каждого apiId
    - API-сервер хранит хранит соответствие GEOIP-регионов и статуса требования проверки
    - API-сервер хранит лог проверок возраста для каждого клиента в формате:
        - apiId (id клиента - сервера игры)
        - clientIp (ip игрока)
        - userId (id игрока в игровом сервере)
        - sessionId (сессия игры)
        - serviceSessionId (сессия сервиса проверки возраста)
        - result:
            - 1 - success
            - 2 - fail
            - 3 - error
        - timestamp
        - geoIpRegion

1. функция проверки возраста, checkAgeVerificationLocal, используя локальные данные
    - возвращает status:int, где status
        - 0 - проверка не требуется
        - 1 - проверка требуется
        - 2 - клиент уже проходил проверку, прошел успешно
        - 3 - клиент уже проходил проверку, провал
    - параметры:
        - clientIp
        - userId
    - проверки:
        1. проверяет, есть ли clientIp в регионах, для которых требуется проверка возраста. Если нет, то возвращает 0
        2. проверяет, есть ли userId в логе проверок возраста для данного apiId. Если есть, то возвращает 2 (пройдена успешно) или 3 (провал)
        3. проверяет, есть ли userId в белом списке для данного apiId. Если нет, то возвращает 0
        4. возвращает 1 (требуется проверка)
2. страница вебхука, которая принимает сообщения от сервиса проверки возраста
    - принимает результат проверки возраста и сохраняет статус проверки:
        - 1 - пройдена успешно
        - 2 - провал
        - 3 - ошибка
    - сохраняет результат проверки в лог по переданному serviceSessionId
3. страница для возврата с сервиса проверки возраста
    - вызывает parent.postMessage({result: "finished"})
4. api/need-verification
    - параметры:
        - clientIp
        - userId
        - signature (HMAC-SHA256(apiKey + параметры))
    - возвращает {result: checkAgeVerificationLocal(clientIp, userId)}
5. api/check-age-verification
    - параметры:
        - sessionId
        - clientIp
        - apiId
        - userId
        - signature (HMAC-SHA256(apiKey + параметры))
    - вызывает функцию checkAgeVerificationLocal(clientIp, userId)
    - если status 1:
        1. Сохраняет запись в лог проверок возраста для данного apiId
            - apiId
            - clientIp
            - userId
            - sessionId
            - geoIpRegion
        2. получает новую сессию serviceSessionId
            - добавляет serviceSessionId в запись лога
        3. формирует ссылку для перенаправления на страницу проверки возраста
        4. возвращает {href: "ссылка на страницу с проверкой"}
    - если статус 0, то возвращает {result: 1}
6. api/check-age-verification-result
    - параметры:
        - sessionId
        - apiId
        - signature (HMAC-SHA256(apiKey + параметры))
    - проверяет, есть ли sessionId в логе проверок возраста для данного apiId.
        - если есть, то возвращает {result: status}
        - если нет, то возвращает {result: 0}
7. api/update-verification-result
    - параметры:
        - sessionId
        - apiId
        - userId
        - signature (HMAC-SHA256(apiKey + параметры))
    - сохраняет userId в запись лога проверок возраста для данного apiId и sessionId
